<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Police CAD v3</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin:0;
  font-family:Segoe UI;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:white;
  display:flex;
  height:100vh;
}

.glass {
  background:rgba(255,255,255,0.08);
  backdrop-filter:blur(10px);
  border-radius:12px;
  padding:10px;
}

#sidebar {
  width:220px;
  padding:10px;
}

#sidebar button {
  width:100%;
  padding:10px;
  margin:5px 0;
  border:none;
  border-radius:8px;
  background:#1abc9c;
  color:white;
  cursor:pointer;
}

#main {
  flex:1;
  display:flex;
  flex-direction:column;
  padding:10px;
}

.section {
  flex:1;
  display:none;
  overflow:auto;
}

table {
  width:100%;
  border-collapse:collapse;
}
td, th {
  padding:6px;
  border-bottom:1px solid rgba(255,255,255,0.1);
}

.status-available { color:#2ecc71; }
.status-enroute { color:#f1c40f; }
.status-onscene { color:#3498db; }
.status-busy { color:#e74c3c; }

#chat {
  height:200px;
  display:flex;
  flex-direction:column;
  margin-top:10px;
}
#messages {
  flex:1;
  overflow:auto;
}
.message {
  margin:4px 0;
}
</style>
</head>
<body>

<div id="sidebar" class="glass">
  <h3>Police CAD</h3>
  <button onclick="showSection('calls')">Calls</button>
  <button onclick="showSection('units')">Units</button>
</div>

<div id="main">

<div id="calls" class="section glass">
  <h3>Active Calls</h3>
  <button onclick="addCall()">Add Call</button>
  <table>
    <thead>
      <tr><th>ID</th><th>Type</th><th>Location</th><th>Assigned Unit</th></tr>
    </thead>
    <tbody id="callsBody"></tbody>
  </table>
</div>

<div id="units" class="section glass">
  <h3>Units</h3>
  <button onclick="addUnit()">Add Unit</button>
  <table>
    <thead>
      <tr><th>ID</th><th>Name</th><th>Status</th></tr>
    </thead>
    <tbody id="unitsBody"></tbody>
  </table>
</div>

<div id="chat" class="glass">
  <div id="messages"></div>
  <div>
    <input id="chatInput" placeholder="Message..." />
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInAnonymously } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAtbzUhg8vT040z9iNEakF_kqEvr7YkPM4",
  authDomain: "police-cad-86ba9.firebaseapp.com",
  projectId: "police-cad-86ba9",
  storageBucket: "police-cad-86ba9.appspot.com",
  messagingSenderId: "687205548242",
  appId: "1:687205548242:web:978717f8cf88e239fded0b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

await signInAnonymously(auth);

/* Section Switching */
window.showSection = function(id){
  document.querySelectorAll(".section").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
};
showSection("calls");

/* REAL-TIME LISTENERS */

onSnapshot(collection(db,"calls"), snapshot=>{
  const body=document.getElementById("callsBody");
  body.innerHTML="";
  snapshot.forEach(docSnap=>{
    const c=docSnap.data();
    body.innerHTML+=`
      <tr ondragover="event.preventDefault()" 
          ondrop="assignUnit(event,'${docSnap.id}')">
        <td>${docSnap.id}</td>
        <td>${c.type}</td>
        <td>${c.location}</td>
        <td>${c.assigned||"None"}</td>
      </tr>`;
  });
});

onSnapshot(collection(db,"units"), snapshot=>{
  const body=document.getElementById("unitsBody");
  body.innerHTML="";
  snapshot.forEach(docSnap=>{
    const u=docSnap.data();
    body.innerHTML+=`
      <tr draggable="true" 
          ondragstart="dragUnit(event,'${docSnap.id}')">
        <td>${docSnap.id}</td>
        <td>${u.name}</td>
        <td class="status-${u.status}">${u.status}</td>
      </tr>`;
  });
});

/* Add Data */

window.addCall = async function(){
  const type=prompt("Call Type");
  const location=prompt("Location");
  if(!type||!location) return;
  await addDoc(collection(db,"calls"),{
    type,location,assigned:null
  });
};

window.addUnit = async function(){
  const name=prompt("Unit Name");
  if(!name) return;
  await addDoc(collection(db,"units"),{
    name,status:"available"
  });
};

/* Drag & Assign */

window.dragUnit = function(e,id){
  e.dataTransfer.setData("unitId",id);
};

window.assignUnit = async function(e,callId){
  e.preventDefault();
  const unitId=e.dataTransfer.getData("unitId");

  await updateDoc(doc(db,"calls",callId),{
    assigned:unitId
  });

  await updateDoc(doc(db,"units",unitId),{
    status:"enroute"
  });
};

/* Live Chat */

onSnapshot(collection(db,"chat"), snapshot=>{
  const container=document.getElementById("messages");
  container.innerHTML="";
  snapshot.forEach(docSnap=>{
    const m=docSnap.data();
    container.innerHTML+=`<div class="message">${m.text}</div>`;
  });
});

window.sendMessage = async function(){
  const input=document.getElementById("chatInput");
  if(!input.value.trim()) return;
  await addDoc(collection(db,"chat"),{
    text:input.value
  });
  input.value="";
};

</script>
</body>
</html>
