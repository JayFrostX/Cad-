<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Enhanced Police CAD</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<style>
  body { margin: 0; font-family: Arial, sans-serif; display: flex; height: 100vh; }
  #sidebar { width: 300px; background: #2c3e50; color: white; display: flex; flex-direction: column; padding: 10px; box-sizing: border-box; }
  #sidebar h2 { margin-top: 0; }
  #sidebar button { margin: 5px 0; padding: 10px; border: none; background: #34495e; color: white; cursor: pointer; }
  #sidebar button:hover { background: #1abc9c; }
  #main { flex: 1; display: flex; flex-direction: column; }
  #calls, #units, #bolos, #arrests, #warrants { flex: 1; overflow-y: auto; padding: 10px; border-bottom: 1px solid #ccc; }
  table { width: 100%; border-collapse: collapse; }
  th, td { border: 1px solid #ccc; padding: 5px; text-align: left; }
  #map { flex: 2; }
  input.unitName { width: 80%; }

  /* AI Chat Styles */
  #aiChatContainer {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 300px;
    height: 400px;
    background: #1a1a1a;
    color: white;
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: 0 0 10px #000;
    z-index: 1000;
  }
  #chatMessages { flex: 1; padding: 10px; overflow-y: auto; font-size: 14px; }
  #chatMessages div { margin-bottom: 8px; }
  #chatInput {
    border: none;
    padding: 10px;
    outline: none;
    width: 100%;
    box-sizing: border-box;
    background: #111;
    color: white;
  }
</style>
</head>
<body>

<div id="sidebar">
  <h2>Police CAD</h2>
  <button onclick="showSection('calls')">Calls</button>
  <button onclick="showSection('units')">Units</button>
  <button onclick="showSection('bolos')">BOLOs</button>
  <button onclick="showSection('arrests')">Arrests</button>
  <button onclick="showSection('warrants')">Warrants</button>
</div>

<div id="main">
  <div id="calls">
    <h3>Active Calls</h3>
    <button onclick="addCall()">Add Call</button>
    <table id="callsTable">
      <thead><tr><th>ID</th><th>Type</th><th>Location</th><th>Status</th><th>Assign</th><th>Action</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="units" style="display:none;">
    <h3>Units</h3>
    <button onclick="addUnit()">Add Unit</button>
    <table id="unitsTable">
      <thead><tr><th>ID</th><th>Name</th><th>Status</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="bolos" style="display:none;">
    <h3>BOLOs / Warrants</h3>
    <button onclick="addBolo()">Add BOLO</button>
    <table id="bolosTable">
      <thead><tr><th>ID</th><th>Description</th><th>Status</th><th>Action</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="arrests" style="display:none;">
    <h3>Arrests</h3>
    <button onclick="addArrest()">Add Arrest</button>
    <table id="arrestsTable">
      <thead><tr><th>ID</th><th>Name</th><th>Reason</th><th>Action</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="warrants" style="display:none;">
    <h3>Arrest Warrants</h3>
    <button onclick="addWarrant()">Add Warrant</button>
    <table id="warrantsTable">
      <thead><tr><th>ID</th><th>Name</th><th>Reason</th><th>Action</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="map"></div>
</div>

<!-- AI Officer Chat -->
<div id="aiChatContainer">
  <div id="chatMessages"></div>
  <input id="chatInput" type="text" placeholder="Talk to AI Officer...">
</div>

<script>
// ---------------- Sections ----------------
function showSection(section) {
  const sections = ['calls','units','bolos','arrests','warrants'];
  sections.forEach(s => document.getElementById(s).style.display = 'none');
  document.getElementById(section).style.display = 'block';
}

// ---------------- Data ----------------
let calls = [];
let units = [
  {id: 1, name: 'Unit 1', status: 'Available', lat: 39.7684, lng: -86.1581, marker: null},
  {id: 2, name: 'Unit 2', status: 'Available', lat: 39.7700, lng: -86.1600, marker: null}
];
let bolos = [];
let arrests = [];
let warrants = [];

// ---------------- Map ----------------
const map = L.map('map').setView([39.7684, -86.1581], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap contributors' }).addTo(map);

// ---------------- Calls ----------------
function addCall() {
  const type = prompt("Enter call type (e.g., Traffic Stop, 911):");
  const location = prompt("Enter location (address or coords as 'lat,lng'):");
  if(!type || !location) return;
  let lat = 39.7684, lng = -86.1581;
  if(location.includes(',')) {
    const parts = location.split(',');
    lat = parseFloat(parts[0]);
    lng = parseFloat(parts[1]);
  }
  const id = calls.length + 1;
  const call = {id, type, location, status: 'Dispatched', assigned: '', lat, lng, marker: null};
  calls.push(call);
  call.marker = L.marker([lat, lng]).addTo(map).bindPopup(`Call #${id}: ${type}`);
  renderCalls();
}

function renderCalls() {
  const tbody = document.querySelector('#callsTable tbody');
  tbody.innerHTML = '';
  calls.forEach(c => {
    const row = document.createElement('tr');
    row.innerHTML = `<td>${c.id}</td><td>${c.type}</td><td>${c.location}</td><td>${c.status}</td>
      <td>${c.assigned || '<button onclick="assignUnit('+c.id+')">Assign</button>'}</td>
      <td><button onclick="closeCall(${c.id})">Close</button></td>`;
    tbody.appendChild(row);
  });
}

// ---------------- Units ----------------
function addUnit() {
  const name = prompt("Enter unit name:");
  if(!name) return;
  const id = units.length + 1;
  const lat = 39.7684 + Math.random()/100;
  const lng = -86.1581 + Math.random()/100;
  const marker = L.marker([lat, lng], {icon: L.icon({iconUrl: 'https://cdn-icons-png.flaticon.com/512/149/149071.png', iconSize: [25,25]})})
                   .addTo(map).bindPopup(`Unit #${id}: ${name}`);
  units.push({id, name, status: 'Available', lat, lng, marker});
  renderUnits();
}

function renderUnits() {
  const tbody = document.querySelector('#unitsTable tbody');
  tbody.innerHTML = '';
  units.forEach(u => {
    const row = document.createElement('tr');
    row.innerHTML = `<td>${u.id}</td>
      <td><input class="unitName" value="${u.name}" onchange="changeUnitName(${u.id}, this.value)"></td>
      <td>${u.status}</td>`;
    tbody.appendChild(row);
  });
}

function changeUnitName(id, newName) {
  const unit = units.find(u => u.id === id);
  if(unit) { unit.name = newName; if(unit.marker) unit.marker.bindPopup(`${unit.name}`).openPopup(); renderCalls(); }
}

// ---------------- BOLOs ----------------
function addBolo() {
  const description = prompt("Enter BOLO/Warrant description:");
  if(!description) return;
  const id = bolos.length + 1;
  bolos.push({id, description, status: 'Active'});
  renderBolos();
}

function deleteBolo(id) {
  bolos = bolos.filter(b => b.id !== id);
  renderBolos();
}

function renderBolos() {
  const tbody = document.querySelector('#bolosTable tbody');
  tbody.innerHTML = '';
  bolos.forEach(b => {
    const row = document.createElement('tr');
    row.innerHTML = `<td>${b.id}</td><td>${b.description}</td><td>${b.status}</td>
      <td><button onclick="deleteBolo(${b.id})">Delete</button></td>`;
    tbody.appendChild(row);
  });
}

// ---------------- Arrests ----------------
function addArrest() {
  const name = prompt("Enter name of arrested person:");
  const reason = prompt("Enter reason for arrest:");
  if(!name || !reason) return;
  const id = arrests.length + 1;
  arrests.push({id, name, reason});
  renderArrests();
}

function deleteArrest(id) {
  arrests = arrests.filter(a => a.id !== id);
  renderArrests();
}

function renderArrests() {
  const tbody = document.querySelector('#arrestsTable tbody');
  tbody.innerHTML = '';
  arrests.forEach(a => {
    const row = document.createElement('tr');
    row.innerHTML = `<td>${a.id}</td><td>${a.name}</td><td>${a.reason}</td>
      <td><button onclick="deleteArrest(${a.id})">Delete</button></td>`;
    tbody.appendChild(row);
  });
}

// ---------------- Warrants ----------------
function addWarrant() {
  const name = prompt("Enter name for warrant:");
  const reason = prompt("Enter reason for warrant:");
  if(!name || !reason) return;
  const id = warrants.length + 1;
  warrants.push({id, name, reason});
  renderWarrants();
}

function deleteWarrant(id) {
  warrants = warrants.filter(w => w.id !== id);
  renderWarrants();
}

function renderWarrants() {
  const tbody = document.querySelector('#warrantsTable tbody');
  tbody.innerHTML = '';
  warrants.forEach(w => {
    const row = document.createElement('tr');
    row.innerHTML = `<td>${w.id}</td><td>${w.name}</td><td>${w.reason}</td>
      <td><button onclick="deleteWarrant(${w.id})">Delete</button></td>`;
    tbody.appendChild(row);
  });
}

// ---------------- AI Officer Chat ----------------
const chatMessages = document.getElementById("chatMessages");
const chatInput = document.getElementById("chatInput");

function addMessage(sender, text) {
    const message = document.createElement("div");
    message.innerHTML = `<b>${sender}:</b> ${text}`;
    chatMessages.appendChild(message);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

async function aiResponse(userMessage) {
    addMessage("AI Officer", "Typing...");
    try {
        const res = await fetch("http://localhost:3000/ai-chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: userMessage })
        });
        const data = await res.json();
        chatMessages.lastChild.remove();
        addMessage("AI Officer", data.reply);
    } catch (err) {
        chatMessages.lastChild.remove();
        addMessage("AI Officer", "Error connecting to AI.");
        console.error(err);
    }
}

chatInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && chatInput.value.trim() !== "") {
        const userText = chatInput.value.trim();
        addMessage("You", userText);
        chatInput.value = "";
        aiResponse(userText);
    }
});

// ---------------- Initial Render ----------------
renderCalls();
renderUnits();
renderBolos();
renderArrests();
renderWarrants();
</script>
</body>
</html>
